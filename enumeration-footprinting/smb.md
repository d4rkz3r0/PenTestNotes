---
description: Server Message Block - TCP Ports 137,138,139,445
---

# SMB

### General Info

#### View Default Samba Configuration

```shell
cat /etc/samba/smb.conf | grep -v "#\|\;" 
```

***

{% code title="Default Script Scan" fullWidth="false" %}
```sh
sudo nmap TARGET_IP -sV -sC -p139,445
```
{% endcode %}

{% code title="SMB Version Detection" %}
```sh
sudo nmap -sV --script=banner -p445 TARGET_IP
```
{% endcode %}

<pre class="language-sh" data-title="OS Detection"><code class="lang-sh"><strong>sudo nmap --script smb-os-discovery.nse -p445 TARGET_IP
</strong></code></pre>

***

### Native SMB Client

{% code title="SMB Share Enumeration" %}
```sh
smbclient -N -L //TARGET_IP
```
{% endcode %}

{% code title="Connect to specific Share" %}
```sh
smbclient //TARGET_IP/SHARE_NAME
```
{% endcode %}

{% code title="Authenticated Connection to specific Share" %}
```sh
smbclient //TARGET_IP/SHARE_NAME -U USERNAME
```
{% endcode %}

{% code title="Execute System Command" %}
```sh
!CMD_TO_EXECUTE FILE_TO_EXECUTE_ON
Example: !cat flag.txt
```
{% endcode %}

***

### RPCClient

{% code title="Connect to SMB Server Anonymously" %}
```
rpcclient -U "" TARGET_IP
```
{% endcode %}

#### RPCClient Commands

<table data-full-width="true"><thead><tr><th>Query</th><th>Description</th></tr></thead><tbody><tr><td><code>srvinfo</code></td><td>Enumerate Server information.</td></tr><tr><td><code>enumdomains</code></td><td>Enumerate all domains that are deployed in the network.</td></tr><tr><td><code>querydominfo</code></td><td>Provides domain, server, and user information of deployed domains.</td></tr><tr><td><code>netshareenumall</code></td><td>Enumerates all available shares.</td></tr><tr><td><code>netsharegetinfo &#x3C;share></code></td><td>Provides information about a specific share.</td></tr><tr><td><code>enumdomusers</code></td><td>Enumerates all domain users.<br>Each user has a &#x3C;RID>.</td></tr><tr><td><code>queryuser &#x3C;RID></code></td><td>Provides information about a specific user, including Group Rid.</td></tr><tr><td><code>querygroup &#x3C;RID></code></td><td>Provides information about a specific group.</td></tr></tbody></table>

{% code title="Brute Force Enum RIDS" %}
```sh
for i in $(seq 500 1100);do rpcclient -N -U "" TARGET_IP -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done// Some code
```
{% endcode %}

***

### **Impacket - Samrdump.py**

```sh
samrdump.py TARGET_IP
```

Source\
[https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py)

***

### SMBMap

{% code title="Enumerate Shares" %}
```sh
smbmap -H TARGET_IP
```
{% endcode %}

Source\
[https://github.com/ShawnDEvans/smbmap](https://github.com/ShawnDEvans/smbmap)

***

### CrackMapExec

{% code title="Enumerate Shares and Server Info" %}
```sh
crackmapexec smb TARGET_IP --shares -u '' -p ''
```
{% endcode %}

Source\
[https://github.com/byt3bl33d3r/CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec)

***

### Enum4Linux-NG

#### Installation Steps

1. ```sh
   git clone https://github.com/cddmp/enum4linux-ng.git
   ```
2. ```sh
   cd enum4linux-ng
   ```
3. ```sh
   pip3 install -r requirements.txt
   ```

#### Enumeration/Usage

```sh
./enum4linux-ng.py TARGET_IP -A
```

Source\
[https://github.com/cddmp/enum4linux-ng](https://github.com/cddmp/enum4linux-ng)
